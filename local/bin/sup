#!/bin/bash
# View/edit standup notes

pr_usage()
{
	echo "usage: sup ts005 # edit"
	echo "       sup edit ts005"
	echo "       sup show ts005 d"
	echo "       sup show ts005 tom"
	echo "       sup format ts005"
	echo "       sup new ct001"
}

pr_err()
{
	>&2 echo "Error: $*"
}

check_env_or_die()
{
	if ! [ -d "$SUP_DIR" ]; then
		pr_err "Could not find SUP_DIR"
		exit 1
	fi
	if ! [ -d "$SUP_LOG_DIR" ]; then
		pr_err "Could not find SUP_LOG_DIR"
		exit 1
	fi

}

pr_sup_file_path()
{
	declare -r pcode="$1"
	declare -r sup_file="$SUP_DIR/${pcode}.md"

	echo "$sup_file"
}

# Edit standup notes for project group
edit()
{
	declare -r pcode="$1"

	"$EDITOR" "$(pr_sup_file_path "$pcode")"
}

# Print the standup file and append the next engineers name.
show()
{
	declare -r pcode="$1" name="$2"
	declare -r sup_file_path="$(pr_sup_file_path "$pcode")"

	if [ -z "$name" ]; then
		pr_usage
		return 1
	fi

	cat "$sup_file_path"
	grep -i "# $name" "$sup_file_path"
}

# Scrape standup notes from this groups IRC log
format()
{
	echo "TODO"
}

# Create new standup notes for project group
new()
{
	declare -r pcode="$1"
	declare -r sup_file_path="$(pr_sup_file_path "$pcode")"

	cat > "$sup_file_path" <<EOF
# Standup Notes $pcode
## Thomas Preston (tpreston)
# Discussion

## Thomas Preston (tpreston)
* Done:
* Doing:
* Next:
* Backlog:
EOF
	edit "$pcode"
}

if [ $# -lt 1 ]; then
	pr_err "Need at least 1 arg"
	pr_usage
	exit 1
fi
check_env_or_die

case "$1" in
"edit")
	edit "$2"
	;;
"format")
	format
	;;
"new")
	new "$2"
	;;
"show")
	show "$2" "$3"
	;;
*)
	edit "$1"
	;;
esac
